var Q=Object.defineProperty;var X=(e,n,o)=>n in e?Q(e,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[n]=o;var C=(e,n,o)=>X(e,typeof n!="symbol"?n+"":n,o);import{a as N}from"./auth-kta0Vm9R.js";const Z="https://helpseller-backend-97701668075.europe-west1.run.app",ee="https://helpseller.vercel.app",Y=Z.trim()||"http://localhost:3001",te=ee.trim()||"http://localhost:3000",q=Y.replace(/\/$/,""),oe=Y.replace(/^http:\/\//,"ws://").replace(/^https:\/\//,"wss://").replace(/\/$/,""),re=te.replace(/\/$/,""),j=`${oe}/ws/call`;let g=null,P=[],A=null,R=0;const L=10;let $=null,W=null,G=null;function ne(e){$=e}function ae(e){W=e}function se(e){G=e}async function H(){var e,n;g&&(g.onclose=null,g.close(),g=null);try{console.log("üîÑ Getting fresh token for WS connection...");const o=await N.getFreshToken(),i=`${j}?token=${o}`;console.log("üîå Connecting WS:",j),g=new WebSocket(i),g.onopen=()=>{for(console.log("‚úÖ WS Connected"),R=0,console.log(`üöÄ Flushing ${P.length} messages from queue...`);P.length>0;){const a=P.shift();try{g.send(a),console.log("üì§ Flushed message:",JSON.parse(a).type)}catch(t){console.error("‚ùå Failed to flush message:",t)}}W&&W()},g.onmessage=a=>{try{const t=JSON.parse(a.data);console.log("üì© WS Message:",t.type),$&&$(t)}catch(t){console.error("‚ùå WS parse error:",t)}},g.onclose=a=>{if(console.error("‚ùå WS Closed",{code:a.code,reason:a.reason||"(no reason)",clean:a.wasClean}),g=null,G&&G(),R>=L){console.error("‚ùå Max reconnect attempts reached, stopping.");return}const t=a.code===1008?Math.min(5e3*Math.pow(1.5,R),3e4):2e3;R++,console.log(`Retrying WS in ${t}ms (attempt ${R}/${L})...`),A&&clearTimeout(A),A=setTimeout(()=>H(),t)},g.onerror=()=>{console.error("‚ùå WS Error (check WS Closed above for code/reason)")}}catch(o){if(console.error("‚ùå Failed to get token or connect:",o.message),(((e=o==null?void 0:o.message)==null?void 0:e.includes("No session found"))||((n=o==null?void 0:o.message)==null?void 0:n.includes("Auth session")))&&R>=2){console.error("Stopping WS reconnect: fa√ßa login no popup da extens√£o.");return}R++;const a=5e3;R<L&&(console.log(`Retrying in ${a}ms (attempt ${R}/${L})...`),A&&clearTimeout(A),A=setTimeout(()=>H(),a))}}function E(e,n){const o=JSON.stringify({type:e,payload:n});if(g&&g.readyState===WebSocket.OPEN)try{g.send(o)}catch(i){console.error(`‚ùå WS Send failed for ${e}:`,i),P.push(o)}else console.log(`‚è≥ WS queuing message: ${e} (State: ${g?g.readyState:"null"})`,n),P.push(o)}const M=class M{async detect(){const n=navigator.hardwareConcurrency||2,o=navigator.deviceMemory||4,i=navigator.connection,a=(i==null?void 0:i.effectiveType)||"unknown",t=await this.measureLatency(),r=n>=M.POWERFUL_THRESHOLD.MIN_CPU_CORES&&o>=M.POWERFUL_THRESHOLD.MIN_MEMORY_GB&&t<M.POWERFUL_THRESHOLD.MAX_LATENCY_MS,d={cpuCores:n,deviceMemory:o,connectionType:a,networkLatency:t,isPowerful:r};return console.log("üñ•Ô∏è Hardware Profile:",d),d}async measureLatency(){const o=[];for(let a=0;a<3;a++){try{const t=performance.now();await fetch(`${q}/health`,{method:"GET",cache:"no-cache"});const r=performance.now()-t;o.push(r)}catch{console.warn(`Ping attempt ${a+1} failed, assuming high latency`),o.push(500)}a<2&&await new Promise(t=>setTimeout(t,100))}const i=o.reduce((a,t)=>a+t,0)/o.length;return Math.round(i)}async reevaluate(){return this.detect()}};C(M,"POWERFUL_THRESHOLD",{MIN_CPU_CORES:4,MIN_MEMORY_GB:4,MAX_LATENCY_MS:150});let x=M;class ce{constructor(){C(this,"worker",null);C(this,"hardwareProfile",null);C(this,"pendingRequests",new Map);C(this,"initialized",!1)}async initialize(){if(this.initialized){console.log("‚ö†Ô∏è Edge coach already initialized");return}console.log("üöÄ Initializing Edge Coach...");const n=new x;if(this.hardwareProfile=await n.detect(),console.log("üñ•Ô∏è Hardware Profile:",{cpuCores:this.hardwareProfile.cpuCores,deviceMemory:this.hardwareProfile.deviceMemory,networkLatency:`${this.hardwareProfile.networkLatency}ms`,isPowerful:this.hardwareProfile.isPowerful}),this.hardwareProfile.isPowerful&&typeof Worker<"u")try{this.worker=new Worker(new URL("/assets/objection-matcher.worker-fIiPJXmq.js",import.meta.url),{type:"module"}),this.worker.onmessage=o=>{this.handleWorkerResult(o.data)},this.worker.onerror=o=>{console.error("Worker error:",o)},console.log("Local matcher worker initialized")}catch(o){console.error("Failed to initialize worker:",o),this.hardwareProfile.isPowerful=!1}else this.hardwareProfile.isPowerful?console.log("Worker API not available (service worker context), using backend only"):console.log("Weak hardware detected, using backend only");this.initialized=!0}async processTranscript(n,o,i){var a;if(o!=="lead"&&o!=="Cliente"&&o!=="client")return null;if(!((a=this.hardwareProfile)!=null&&a.isPowerful)||!this.worker)return console.log("üì° Using backend (weak hardware or no worker)"),null;if(i.length===0)return console.warn("‚ö†Ô∏è No cached objections, falling back to backend"),null;try{const t=performance.now(),r=await this.matchLocal(n,i,200),d=performance.now()-t;return r.result?console.log(`‚ö° LOCAL MATCH: ${Math.round(d)}ms | Score: ${r.result.score.toFixed(2)} | ${r.result.coachingTip.substring(0,50)}...`):console.log(`‚ö° LOCAL: No match (${Math.round(d)}ms)`),r.result}catch(t){return t instanceof Error&&t.message==="Timeout"?console.warn("‚è±Ô∏è Local timeout (>200ms), falling back to backend"):console.error("‚ùå Local processing error:",t),null}}matchLocal(n,o,i){return new Promise((a,t)=>{const r=Math.random().toString(36).substring(2),d=setTimeout(()=>{this.pendingRequests.delete(r),t(new Error("Timeout"))},i);this.pendingRequests.set(r,{resolve:a,reject:t,timeoutId:d}),this.worker.postMessage({requestId:r,text:n,objections:o})})}handleWorkerResult(n){const o=this.pendingRequests.get(n.requestId);o&&(clearTimeout(o.timeoutId),o.resolve(n),this.pendingRequests.delete(n.requestId))}getHardwareProfile(){return this.hardwareProfile}destroy(){this.worker&&(this.worker.terminate(),this.worker=null),this.pendingRequests.clear(),this.initialized=!1,console.log("üõë Edge coach destroyed")}}const K=new ce;console.log("Background Service Worker Starting...");K.initialize().then(()=>{console.log("‚úÖ Edge coach initialized")}).catch(e=>{console.error("‚ùå Edge coach initialization failed:",e)});let _="",B=!1,w=null,F=[],D=!1,z=null,b=[],l=null;ae(()=>{l&&(clearInterval(l),l=null);const e=1500;setTimeout(()=>{w&&(console.log("üîÑ Re-sending call:start on reconnect (after",e,"ms):",w),E("call:start",w)),_&&(console.log("üë§ Re-sending lead name on reconnect:",_),E("call:participants",{leadName:_,allParticipants:[]}))},e)});se(()=>{D=!1});ne(async e=>{var n,o,i,a,t,r,d;if(e.type==="call:started"){const s=(n=e.payload)==null?void 0:n.callId;if(console.log("‚úÖ Call started confirmed by backend. CallId:",s),D=!0,l&&(clearInterval(l),l=null),b.length>0){console.log(`Open floodgates: Sending ${b.length} buffered audio segments...`);for(const u of b)E("audio:segment",u);b=[]}if(s&&s!==z){z=s;try{const u=await N.getFreshToken(),f=await N.getSession(),c=((o=f==null?void 0:f.user)==null?void 0:o.id)??"unknown",h=await fetch(`${re}/api/livekit/token`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`},body:JSON.stringify({roomName:s,identity:`seller_${c}`,role:"publisher"})});if(h.ok){const{token:y,serverUrl:T}=await h.json();y&&T&&chrome.runtime.sendMessage({type:"START_LIVEKIT_PUBLISH",token:y,serverUrl:T}).catch(O=>console.warn("‚ö†Ô∏è Send START_LIVEKIT_PUBLISH failed:",O))}else{const y=await h.json().catch(()=>({}));console.warn("‚ö†Ô∏è LiveKit token failed:",y.error??h.statusText)}}catch(u){console.error("‚ùå LiveKit token/publish setup:",u)}}const{scriptId:m}=w||{};if(m)try{const u=await N.getFreshToken(),f=await fetch(`${q}/api/scripts/${m}/objections`,{headers:{Authorization:`Bearer ${u}`}});if(f.ok){const c=await f.json();F=c,console.log(`üì¶ Cached ${c.length} objections for edge processing`)}else console.warn("‚ö†Ô∏è Failed to fetch objections for caching")}catch(u){console.error("‚ùå Error caching objections:",u)}}if(e.type==="transcript:chunk"){const s=e.payload||{},m=s.text||"",u=s.speaker||s.role;if(console.log("üìù Received transcript:",m.substring(0,50),"speaker:",u),(u==="lead"||u==="Cliente")&&F.length>0)try{const c=await K.processTranscript(m,u,F);if(c){const h=await p();h.currentTabId&&chrome.tabs.sendMessage(h.currentTabId,{type:"COACHING_MESSAGE",data:{type:"objection",title:"OBJE√á√ÉO DETECTADA",description:c.coachingTip,metadata:c}}).catch(()=>{}),console.log("‚ö° LOCAL COACHING DELIVERED")}}catch(c){console.error("‚ùå Edge processing error:",c)}const f=await p();f.currentTabId&&chrome.tabs.sendMessage(f.currentTabId,{type:"TRANSCRIPT_RESULT",data:{text:m,isFinal:s.isFinal??!0,timestamp:Date.now(),speaker:s.speaker??(s.role==="seller"?"Voc√™":"Cliente"),role:s.role}}).catch(c=>{console.warn("Failed to send transcript to content script:",c.message)})}if(e.type==="coach:message"||e.type==="COACHING_MESSAGE"){console.log("üì° BACKEND COACHING:",(i=JSON.stringify(e.payload))==null?void 0:i.substring(0,80));const s=await p();s.currentTabId&&chrome.tabs.sendMessage(s.currentTabId,{type:"COACHING_MESSAGE",data:e.payload}).catch(()=>{})}if(e.type==="coach:whisper"){console.log("üëî MANAGER WHISPER:",(t=(a=e.payload)==null?void 0:a.content)==null?void 0:t.substring(0,50));const s=await p();s.currentTabId&&chrome.tabs.sendMessage(s.currentTabId,{type:"MANAGER_WHISPER",data:{type:"manager-whisper",source:"manager",content:e.payload.content,urgency:e.payload.urgency||"normal",timestamp:e.payload.timestamp}}).catch(()=>{})}if(e.type==="objection:detected"){console.log("‚ö° OBJECTION DETECTED:",(d=(r=e.payload)==null?void 0:r.objection)==null?void 0:d.substring(0,50));const s=await p();s.currentTabId&&chrome.tabs.sendMessage(s.currentTabId,{type:"OBJECTION_DETECTED",data:{objection:e.payload.objection,phase:e.payload.phase,tip:e.payload.tip}}).catch(()=>{})}if(e.type==="error"){console.error("‚ùå BACKEND ERROR:",e.payload);const s=await p();s.currentTabId&&chrome.tabs.sendMessage(s.currentTabId,{type:"STATUS_UPDATE",status:"ERROR",error:e.payload.message||"Erro no servidor"}).catch(()=>{})}});async function p(){const e=await chrome.storage.session.get(["streamId","currentTabId","isRecording","recordingStartedAt"]);return{streamId:e.streamId,currentTabId:e.currentTabId,isRecording:!!e.isRecording,recordingStartedAt:e.recordingStartedAt||null}}async function k(e){await chrome.storage.session.set(e)}let U=null;chrome.action.onClicked.addListener(async e=>{e.id&&(console.log("Extension icon clicked (v2 - lazy capture)..."),await k({currentTabId:e.id}),chrome.tabs.sendMessage(e.id,{type:"TOGGLE_SIDEBAR"}).catch(n=>{console.log("Content script not injected yet:",n)}))});let I=!1;chrome.runtime.onMessage.addListener((e,n,o)=>{console.log(`üì© Background received message: ${e.type}`,{senderId:n.id,senderUrl:n.url});const i=async()=>{var a;if(e.type==="START_CAPTURE")le(e.tabId||((a=n.tab)==null?void 0:a.id));else if(e.type==="STOP_CAPTURE")J();else if(e.type==="TRY_END_CALL")E("call:end",{});else if(e.type==="OFFSCREEN_READY")console.log("‚úÖ [Event]: OFFSCREEN_READY - Generating fresh StreamID..."),ie();else if(e.type==="OFFSCREEN_LOG")console.log("üñ•Ô∏è [Offscreen]:",e.message);else if(e.type==="RECORDING_STARTED"){const t=!!e.micAvailable;console.log("üéôÔ∏è Recording started, microfone:",t?"permitido":"n√£o dispon√≠vel"),p().then(r=>{r.currentTabId&&chrome.tabs.sendMessage(r.currentTabId,{type:"STATUS_UPDATE",status:"RECORDING",micAvailable:t}).catch(()=>{})}),chrome.runtime.sendMessage({type:"STATUS_UPDATE",status:"RECORDING",micAvailable:t}).catch(()=>{})}else if(e.type==="AUDIO_CHUNK")E("audio:chunk",{audio:e.data});else if(e.type==="AUDIO_SEGMENT"){const t=e.role||e.speaker||"unknown";console.log(`üì§ Sending audio segment: ${e.size} bytes, role: ${t}`);const r={audio:e.data,size:e.size,role:t,speakerName:e.speakerName};D?E("audio:segment",r):(console.log("‚è≥ Buffering audio segment (call not confirmed yet)..."),b.push(r))}else if(e.type==="MEDIA_STREAM_CHUNK")E("media:stream",{chunk:e.data,size:e.size,timestamp:e.timestamp,isHeader:!!e.isHeader});else if(e.type==="PARTICIPANT_INFO")_=e.leadName||"",console.log("üë§ Lead name:",_),E("call:participants",{leadName:e.leadName||"Lead",selfName:e.selfName,allParticipants:e.allParticipants||[]});else if(e.type==="MIC_STATE")B=e.muted,console.log("üé§ Mic state:",e.muted?"MUTED":"ACTIVE"),chrome.storage.local.set({micMuted:e.muted}).catch(()=>{}),chrome.runtime.sendMessage({type:"MIC_MUTE_STATE",muted:e.muted}).catch(()=>{});else if(e.type==="TRANSCRIPT_RESULT")E("transcript:chunk",e.data),p().then(t=>{t.currentTabId&&chrome.tabs.sendMessage(t.currentTabId,{type:"TRANSCRIPT_RESULT",data:e.data}).catch(r=>{console.error("‚ùå Failed to send transcript to sidebar:",r)})});else if(e.type==="QUERY_ACTIVE_SPEAKER"){let t=!1;const r=s=>{if(!t){t=!0;try{o(s)}catch{}}},d=setTimeout(()=>r({speakerName:null}),2e3);try{const s=await p();if(s.currentTabId){const m=await chrome.tabs.sendMessage(s.currentTabId,{type:"GET_ACTIVE_SPEAKER"});clearTimeout(d),r({speakerName:(m==null?void 0:m.activeSpeaker)??null})}else clearTimeout(d),r({speakerName:null})}catch(s){clearTimeout(d),console.warn("Failed to query active speaker from content script:",s),r({speakerName:null})}}};return e.type==="QUERY_ACTIVE_SPEAKER"?(i(),!0):e.type==="GET_STATUS"?(p().then(a=>{const t=a.isRecording?"RECORDING":"PROGRAMMED";try{o({status:t,recordingStartedAt:a.recordingStartedAt??null})}catch{}}).catch(()=>{try{o({status:"PROGRAMMED",recordingStartedAt:null})}catch{}}),!0):(i(),!1)});async function ie(){console.log("‚úÖ [Event]: OFFSCREEN_READY signal received.")}async function le(e){var o,i,a;if(I){console.warn("‚ö†Ô∏è startCapture ignored: already processing");return}e&&(console.log(`üìå Using explicit tab ID from sender: ${e}`),await k({currentTabId:e}));const n=await p();if(n.isRecording){console.log("‚ö†Ô∏è startCapture ignored: already recording");return}if(!n.currentTabId){console.error("‚ùå No currentTabId available. Icon must be clicked first."),S("ERROR");return}I=!0;try{const t=await chrome.tabs.get(n.currentTabId);console.log("üöÄ Initiating capture flow for:",t.url),await k({isRecording:!0,recordingStartedAt:Date.now()}),S("RECORDING"),D=!1,b=[];const r=await N.getSession();if(console.log("üîë Token Debug:",{sessionPresent:!!r,accessTokenPresent:!!(r!=null&&r.access_token),accessTokenLength:(o=r==null?void 0:r.access_token)==null?void 0:o.length,accessTokenPrefix:((i=r==null?void 0:r.access_token)==null?void 0:i.substring(0,30))+"...",expiresAt:r!=null&&r.expires_at?new Date(r.expires_at*1e3).toISOString():"N/A"}),!(r!=null&&r.access_token)){console.error("‚ùå No access token available! User may need to log in."),S("ERROR"),await k({isRecording:!1}),I=!1;return}console.log("üîå Connecting WebSocket..."),console.log("üîå Connecting WebSocket..."),await H();const d="offscreen/index.html",s=chrome.runtime.getURL(d);if((await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"],documentUrls:[s]})).length===0){const f=new Promise((c,h)=>{const y=setTimeout(()=>{chrome.runtime.onMessage.removeListener(T),h(new Error("Timeout waiting for OFFSCREEN_READY"))},1e4),T=O=>{O.type==="OFFSCREEN_READY"&&(console.log("‚úÖ OFFSCREEN_READY received (Promise resolved)"),chrome.runtime.onMessage.removeListener(T),clearTimeout(y),c())};chrome.runtime.onMessage.addListener(T)});console.log("Creating offscreen document...",s);try{await chrome.offscreen.createDocument({url:s,reasons:["USER_MEDIA","AUDIO_PLAYBACK"],justification:"Recording tab audio for real-time transcription"})}catch(c){if(c.message.includes("Only a single offscreen"))console.log("‚úÖ Offscreen document already exists (caught error)");else throw c}console.log("‚è≥ Waiting for OFFSCREEN_READY..."),await f}else console.log("‚úÖ Offscreen document already exists");U=d,console.log("üé• Requesting MediaStreamId for tab:",n.currentTabId);const u=await new Promise((f,c)=>{chrome.tabCapture.getMediaStreamId({targetTabId:n.currentTabId},h=>{chrome.runtime.lastError?c(chrome.runtime.lastError):h?f(h):c(new Error("Got empty streamId"))})});if(console.log("‚úÖ Fresh StreamID generated:",u),console.log("üì§ Sending INIT_RECORDING to offscreen..."),await chrome.runtime.sendMessage({type:"INIT_RECORDING",streamId:u}),console.log("üì§ Sending initial mic state to offscreen:",B?"MUTED":"ACTIVE"),await chrome.runtime.sendMessage({type:"MIC_MUTE_STATE",muted:B}),r!=null&&r.access_token){const f=await chrome.tabs.get(n.currentTabId).catch(()=>t),c=(f==null?void 0:f.url)??(t==null?void 0:t.url)??"",h=c.match(/meet\.google\.com\/([a-z0-9-]+)/),y=h?h[1]:null;!y&&(c!=null&&c.includes("meet.google.com")||(a=t==null?void 0:t.url)!=null&&a.includes("meet.google.com"))&&console.warn("‚ö†Ô∏è externalId is null but tab has Meet URL ‚Äî re-record may create new call. url=",c==null?void 0:c.slice(0,80)),w={platform:de(c),scriptId:"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",leadName:_,externalId:y},console.log("üì§ Sending call:start (externalId for re-record):",w),E("call:start",w);const T=10,O=5e3;let v=0;l&&clearInterval(l),l=setInterval(()=>{if(D){l&&(clearInterval(l),l=null);return}if(p().then(V=>{if(!V.isRecording){l&&(clearInterval(l),l=null);return}}),v++,v>=T){console.error("‚ùå Call start failed after",T,"attempts (backend timeout)"),l&&(clearInterval(l),l=null),S("ERROR");return}console.log(`üîÑ Retrying call:start (attempt ${v}/${T})...`),w&&E("call:start",w)},O)}}catch(t){console.error("‚ùå startCapture failed:",t),t.message&&t.message.includes("Extension has not been invoked")?S("PERMISSION_REQUIRED"):S("ERROR"),await k({isRecording:!1}),U&&await J()}finally{I=!1}}async function J(){if(I){console.warn("‚ö†Ô∏è stopCapture ignored: already processing");return}if(!(await p()).isRecording){console.log("‚ö†Ô∏è stopCapture ignored: not currently recording");return}I=!0,console.log("‚èπÔ∏è Stopping capture...");try{chrome.runtime.sendMessage({type:"STOP_RECORDING"}).catch(()=>{console.log("Offscreen not reachable (already closed?)")}),U&&(await chrome.offscreen.closeDocument(),U=null),await k({isRecording:!1,recordingStartedAt:null}),z=null,S("PROGRAMMED"),E("call:end",{})}catch(n){console.error("‚ùå stopCapture failed:",n)}finally{I=!1}}async function S(e){const n=await p();console.log("Broadcasting status:",e),n.currentTabId&&chrome.tabs.sendMessage(n.currentTabId,{type:"STATUS_UPDATE",status:e}).catch(()=>{}),chrome.runtime.sendMessage({type:"STATUS_UPDATE",status:e}).catch(()=>{})}function de(e){return e?e.includes("meet.google.com")?"GOOGLE_MEET":e.includes("zoom.us")?"ZOOM_WEB":"OTHER":"OTHER"}
