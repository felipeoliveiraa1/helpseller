var oe=Object.defineProperty;var re=(e,n,r)=>n in e?oe(e,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[n]=r;var b=(e,n,r)=>re(e,typeof n!="symbol"?n+"":n,r);import{a as _}from"./auth-DmuFIzIA.js";const ne="http://localhost:3001",ae="http://localhost:3000",X=ne.trim()||"http://localhost:3001",se=ae.trim()||"http://localhost:3000",Q=X.replace(/\/$/,""),ce=X.replace(/^http:\/\//,"ws://").replace(/^https:\/\//,"wss://").replace(/\/$/,""),ie=se.replace(/\/$/,""),J=`${ce}/ws/call`;let m=null,D=[],O=null,R=0;const F=10;let B=null,x=null,z=null;function le(e){B=e}function de(e){x=e}function ue(e){z=e}async function K(){var e,n;m&&(m.onclose=null,m.close(),m=null);try{console.log("üîÑ Getting fresh token for WS connection...");const r=await _.getFreshToken(),c=`${J}?token=${r}`;console.log("üîå Connecting WS:",J),m=new WebSocket(c),m.onopen=()=>{for(console.log("‚úÖ WS Connected"),R=0,console.log(`üöÄ Flushing ${D.length} messages from queue...`);D.length>0;){const s=D.shift();try{m.send(s),console.log("üì§ Flushed message:",JSON.parse(s).type)}catch(t){console.error("‚ùå Failed to flush message:",t)}}x&&x()},m.onmessage=s=>{try{const t=JSON.parse(s.data);console.log("üì© WS Message:",t.type),B&&B(t)}catch(t){console.error("‚ùå WS parse error:",t)}},m.onclose=s=>{if(console.error("‚ùå WS Closed",{code:s.code,reason:s.reason||"(no reason)",clean:s.wasClean}),m=null,z&&z(),R>=F){console.error("‚ùå Max reconnect attempts reached, stopping.");return}const t=s.code===1008?Math.min(5e3*Math.pow(1.5,R),3e4):2e3;R++,console.log(`Retrying WS in ${t}ms (attempt ${R}/${F})...`),O&&clearTimeout(O),O=setTimeout(()=>K(),t)},m.onerror=()=>{console.error("‚ùå WS Error (check WS Closed above for code/reason)")}}catch(r){if(console.error("‚ùå Failed to get token or connect:",r.message),(((e=r==null?void 0:r.message)==null?void 0:e.includes("No session found"))||((n=r==null?void 0:r.message)==null?void 0:n.includes("Auth session")))&&R>=2){console.error("Stopping WS reconnect: fa√ßa login no popup da extens√£o.");return}R++;const s=5e3;R<F&&(console.log(`Retrying in ${s}ms (attempt ${R}/${F})...`),O&&clearTimeout(O),O=setTimeout(()=>K(),s))}}function y(e,n){const r=JSON.stringify({type:e,payload:n});if(m&&m.readyState===WebSocket.OPEN)try{m.send(r)}catch(c){console.error(`‚ùå WS Send failed for ${e}:`,c),D.push(r)}else console.log(`‚è≥ WS queuing message: ${e} (State: ${m?m.readyState:"null"})`,n),D.push(r)}const P=class P{async detect(){const n=navigator.hardwareConcurrency||2,r=navigator.deviceMemory||4,c=navigator.connection,s=(c==null?void 0:c.effectiveType)||"unknown",t=await this.measureLatency(),o=n>=P.POWERFUL_THRESHOLD.MIN_CPU_CORES&&r>=P.POWERFUL_THRESHOLD.MIN_MEMORY_GB&&t<P.POWERFUL_THRESHOLD.MAX_LATENCY_MS,l={cpuCores:n,deviceMemory:r,connectionType:s,networkLatency:t,isPowerful:o};return console.log("üñ•Ô∏è Hardware Profile:",l),l}async measureLatency(){const r=[];for(let s=0;s<3;s++){try{const t=performance.now();await fetch(`${Q}/health`,{method:"GET",cache:"no-cache"});const o=performance.now()-t;r.push(o)}catch{console.warn(`Ping attempt ${s+1} failed, assuming high latency`),r.push(500)}s<2&&await new Promise(t=>setTimeout(t,100))}const c=r.reduce((s,t)=>s+t,0)/r.length;return Math.round(c)}async reevaluate(){return this.detect()}};b(P,"POWERFUL_THRESHOLD",{MIN_CPU_CORES:4,MIN_MEMORY_GB:4,MAX_LATENCY_MS:150});let q=P;class fe{constructor(){b(this,"worker",null);b(this,"hardwareProfile",null);b(this,"pendingRequests",new Map);b(this,"initialized",!1)}async initialize(){if(this.initialized){console.log("‚ö†Ô∏è Edge coach already initialized");return}console.log("üöÄ Initializing Edge Coach...");const n=new q;if(this.hardwareProfile=await n.detect(),console.log("üñ•Ô∏è Hardware Profile:",{cpuCores:this.hardwareProfile.cpuCores,deviceMemory:this.hardwareProfile.deviceMemory,networkLatency:`${this.hardwareProfile.networkLatency}ms`,isPowerful:this.hardwareProfile.isPowerful}),this.hardwareProfile.isPowerful&&typeof Worker<"u")try{this.worker=new Worker(new URL("/assets/objection-matcher.worker-fIiPJXmq.js",import.meta.url),{type:"module"}),this.worker.onmessage=r=>{this.handleWorkerResult(r.data)},this.worker.onerror=r=>{console.error("Worker error:",r)},console.log("Local matcher worker initialized")}catch(r){console.error("Failed to initialize worker:",r),this.hardwareProfile.isPowerful=!1}else this.hardwareProfile.isPowerful?console.log("Worker API not available (service worker context), using backend only"):console.log("Weak hardware detected, using backend only");this.initialized=!0}async processTranscript(n,r,c){var s;if(r!=="lead"&&r!=="Cliente"&&r!=="client")return null;if(!((s=this.hardwareProfile)!=null&&s.isPowerful)||!this.worker)return console.log("üì° Using backend (weak hardware or no worker)"),null;if(c.length===0)return console.warn("‚ö†Ô∏è No cached objections, falling back to backend"),null;try{const t=performance.now(),o=await this.matchLocal(n,c,200),l=performance.now()-t;return o.result?console.log(`‚ö° LOCAL MATCH: ${Math.round(l)}ms | Score: ${o.result.score.toFixed(2)} | ${o.result.coachingTip.substring(0,50)}...`):console.log(`‚ö° LOCAL: No match (${Math.round(l)}ms)`),o.result}catch(t){return t instanceof Error&&t.message==="Timeout"?console.warn("‚è±Ô∏è Local timeout (>200ms), falling back to backend"):console.error("‚ùå Local processing error:",t),null}}matchLocal(n,r,c){return new Promise((s,t)=>{const o=Math.random().toString(36).substring(2),l=setTimeout(()=>{this.pendingRequests.delete(o),t(new Error("Timeout"))},c);this.pendingRequests.set(o,{resolve:s,reject:t,timeoutId:l}),this.worker.postMessage({requestId:o,text:n,objections:r})})}handleWorkerResult(n){const r=this.pendingRequests.get(n.requestId);r&&(clearTimeout(r.timeoutId),r.resolve(n),this.pendingRequests.delete(n.requestId))}getHardwareProfile(){return this.hardwareProfile}destroy(){this.worker&&(this.worker.terminate(),this.worker=null),this.pendingRequests.clear(),this.initialized=!1,console.log("üõë Edge coach destroyed")}}const Z=new fe;console.log("Background Service Worker Starting...");Z.initialize().then(()=>{console.log("‚úÖ Edge coach initialized")}).catch(e=>{console.error("‚ùå Edge coach initialization failed:",e)});let L="",j=!1,w=null,H=[],U=!1,G=null,M=[],g=null;de(()=>{g&&(clearInterval(g),g=null);const e=1500;setTimeout(()=>{w&&(console.log("üîÑ Re-sending call:start on reconnect (after",e,"ms):",w),y("call:start",w)),L&&(console.log("üë§ Re-sending lead name on reconnect:",L),y("call:participants",{leadName:L,allParticipants:[]}))},e)});ue(()=>{U=!1});le(async e=>{var n,r,c,s,t,o,l,u,p,S,E,d;if(e.type==="call:started"){const a=(n=e.payload)==null?void 0:n.callId;if(console.log("‚úÖ Call started confirmed by backend. CallId:",a),console.log("üé¨ Requesting LiveKit token for room:",a),U=!0,g&&(clearInterval(g),g=null),M.length>0){console.log(`Open floodgates: Sending ${M.length} buffered audio segments...`);for(const i of M)y("audio:segment",i);M=[]}if(a&&a!==G){G=a;try{const i=`${ie}/api/livekit/token`;console.log("üé¨ Requesting LiveKit token for room:",a,"url:",i);const I=await _.getFreshToken(),f=await _.getSession(),k=((r=f==null?void 0:f.user)==null?void 0:r.id)??"unknown",v=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${I}`},body:JSON.stringify({roomName:a,identity:`seller_${k}`,role:"publisher"})});if(v.ok){const W=await v.json(),{token:Y,serverUrl:V}=W;Y&&V?(console.log("‚úÖ LiveKit token received"),console.log("‚úÖ Sending START_LIVEKIT_PUBLISH to offscreen (video will appear in dashboard when published)"),chrome.runtime.sendMessage({type:"START_LIVEKIT_PUBLISH",token:Y,serverUrl:V}).catch(te=>console.warn("‚ö†Ô∏è Send START_LIVEKIT_PUBLISH failed:",te))):(console.warn("‚ö†Ô∏è LiveKit token missing token or serverUrl. No video in dashboard until fixed."),console.warn("   ‚Üí Set NEXT_PUBLIC_LIVEKIT_URL in the dashboard (Vercel) and redeploy."))}else{const W=await v.json().catch(()=>({}));console.warn("‚ö†Ô∏è LiveKit token failed:",W.error??v.statusText)}}catch(i){console.error("‚ùå LiveKit token/publish setup:",i)}}const{scriptId:T}=w||{};if(T)try{const i=await _.getFreshToken(),I=await fetch(`${Q}/api/scripts/${T}/objections`,{headers:{Authorization:`Bearer ${i}`}});if(I.ok){const f=await I.json();H=f,console.log(`üì¶ Cached ${f.length} objections for edge processing`)}}catch{}}if(e.type==="transcript:chunk"){const a=e.payload||{},T=a.text||"",i=a.speaker||a.role;if(console.log("üìù Received transcript:",T.substring(0,50),"speaker:",i),(i==="lead"||i==="Cliente")&&H.length>0)try{const f=await Z.processTranscript(T,i,H);if(f){const k=await h();k.currentTabId&&chrome.tabs.sendMessage(k.currentTabId,{type:"COACHING_MESSAGE",data:{type:"objection",title:"OBJE√á√ÉO DETECTADA",description:f.coachingTip,metadata:f}}).catch(()=>{}),console.log("‚ö° LOCAL COACHING DELIVERED")}}catch(f){console.error("‚ùå Edge processing error:",f)}const I=await h();I.currentTabId&&chrome.tabs.sendMessage(I.currentTabId,{type:"TRANSCRIPT_RESULT",data:{text:T,isFinal:a.isFinal??!0,timestamp:Date.now(),speaker:a.speaker??(a.role==="seller"?"Voc√™":"Cliente"),role:a.role}}).catch(f=>{console.warn("Failed to send transcript to content script:",f.message)})}if(e.type==="coach:message"||e.type==="COACHING_MESSAGE"){console.log("üì° BACKEND COACHING:",(c=JSON.stringify(e.payload))==null?void 0:c.substring(0,80));const a=await h();a.currentTabId&&chrome.tabs.sendMessage(a.currentTabId,{type:"COACHING_MESSAGE",data:e.payload}).catch(()=>{})}if(e.type==="coach:whisper"){console.log("üëî MANAGER WHISPER:",(t=(s=e.payload)==null?void 0:s.content)==null?void 0:t.substring(0,50));const a=await h();a.currentTabId&&chrome.tabs.sendMessage(a.currentTabId,{type:"MANAGER_WHISPER",data:{type:"manager-whisper",source:"manager",content:e.payload.content,urgency:e.payload.urgency||"normal",timestamp:e.payload.timestamp}}).catch(()=>{})}if(e.type==="coach:token"){const a=await h();a.currentTabId&&chrome.tabs.sendMessage(a.currentTabId,{type:"COACH_TOKEN",data:{token:(o=e.payload)==null?void 0:o.token,timestamp:(l=e.payload)==null?void 0:l.timestamp}}).catch(()=>{})}if(e.type==="coach:done"){const a=await h();a.currentTabId&&chrome.tabs.sendMessage(a.currentTabId,{type:"COACH_DONE",data:{timestamp:(u=e.payload)==null?void 0:u.timestamp}}).catch(()=>{})}if(e.type==="coach:thinking"){const a=await h();a.currentTabId&&chrome.tabs.sendMessage(a.currentTabId,{type:"COACH_THINKING",data:{timestamp:(p=e.payload)==null?void 0:p.timestamp}}).catch(()=>{})}if(e.type==="coach:idle"){const a=await h();a.currentTabId&&chrome.tabs.sendMessage(a.currentTabId,{type:"COACH_IDLE",data:{timestamp:(S=e.payload)==null?void 0:S.timestamp}}).catch(()=>{})}if(e.type==="objection:detected"){console.log("‚ö° OBJECTION DETECTED:",(d=(E=e.payload)==null?void 0:E.objection)==null?void 0:d.substring(0,50));const a=await h();a.currentTabId&&chrome.tabs.sendMessage(a.currentTabId,{type:"OBJECTION_DETECTED",data:{objection:e.payload.objection,phase:e.payload.phase,tip:e.payload.tip}}).catch(()=>{})}if(e.type==="error"){console.error("‚ùå BACKEND ERROR:",e.payload);const a=await h();a.currentTabId&&chrome.tabs.sendMessage(a.currentTabId,{type:"STATUS_UPDATE",status:"ERROR",error:e.payload.message||"Erro no servidor"}).catch(()=>{})}});async function h(){const e=await chrome.storage.session.get(["streamId","currentTabId","isRecording","recordingStartedAt"]);return{streamId:e.streamId,currentTabId:e.currentTabId,isRecording:!!e.isRecording,recordingStartedAt:e.recordingStartedAt||null}}async function N(e){await chrome.storage.session.set(e)}let $=null;chrome.action.onClicked.addListener(async e=>{e.id&&(console.log("Extension icon clicked (v2 - lazy capture)..."),await N({currentTabId:e.id}),chrome.tabs.sendMessage(e.id,{type:"TOGGLE_SIDEBAR"}).catch(n=>{console.log("Content script not injected yet:",n)}))});let A=!1;chrome.runtime.onMessage.addListener((e,n,r)=>{console.log(`üì© Background received message: ${e.type}`,{senderId:n.id,senderUrl:n.url});const c=async()=>{var s;if(e.type==="START_CAPTURE")he(e.tabId||((s=n.tab)==null?void 0:s.id));else if(e.type==="STOP_CAPTURE"){const t=e.result;ee(t)}else if(e.type==="TRY_END_CALL")y("call:end",{callId:G??void 0});else if(e.type==="OFFSCREEN_READY")console.log("‚úÖ [Event]: OFFSCREEN_READY - Generating fresh StreamID..."),ge();else if(e.type==="OFFSCREEN_LOG")console.log("üñ•Ô∏è [Offscreen]:",e.message);else if(e.type==="RECORDING_STARTED"){const t=!!e.micAvailable;console.log("üéôÔ∏è Recording started, microfone:",t?"permitido":"n√£o dispon√≠vel"),h().then(o=>{o.currentTabId&&chrome.tabs.sendMessage(o.currentTabId,{type:"STATUS_UPDATE",status:"RECORDING",micAvailable:t}).catch(()=>{})}),chrome.runtime.sendMessage({type:"STATUS_UPDATE",status:"RECORDING",micAvailable:t}).catch(()=>{})}else if(e.type==="AUDIO_CHUNK")y("audio:chunk",{audio:e.data});else if(e.type==="AUDIO_SEGMENT"){const t=e.role||e.speaker||"unknown";console.log(`üì§ Sending audio segment: ${e.size} bytes, role: ${t}`);const o={audio:e.data,size:e.size,role:t,speakerName:e.speakerName};U?y("audio:segment",o):(console.log("‚è≥ Buffering audio segment (call not confirmed yet)..."),M.push(o))}else if(e.type==="MEDIA_STREAM_CHUNK")y("media:stream",{chunk:e.data,size:e.size,timestamp:e.timestamp,isHeader:!!e.isHeader});else if(e.type==="PARTICIPANT_INFO")L=e.leadName||"",console.log("üë§ Lead name:",L),y("call:participants",{leadName:e.leadName||"Lead",selfName:e.selfName,allParticipants:e.allParticipants||[]});else if(e.type==="MIC_STATE")j=e.muted,console.log("üé§ Mic state:",e.muted?"MUTED":"ACTIVE"),chrome.storage.local.set({micMuted:e.muted}).catch(()=>{}),chrome.runtime.sendMessage({type:"MIC_MUTE_STATE",muted:e.muted}).catch(()=>{});else if(e.type==="TRANSCRIPT_RESULT")y("transcript:chunk",e.data),h().then(t=>{t.currentTabId&&chrome.tabs.sendMessage(t.currentTabId,{type:"TRANSCRIPT_RESULT",data:e.data}).catch(o=>{console.error("‚ùå Failed to send transcript to sidebar:",o)})});else if(e.type==="QUERY_ACTIVE_SPEAKER"){let t=!1;const o=u=>{if(!t){t=!0;try{r(u)}catch{}}},l=setTimeout(()=>o({speakerName:null}),2e3);try{const u=await h();if(u.currentTabId){const p=await chrome.tabs.sendMessage(u.currentTabId,{type:"GET_ACTIVE_SPEAKER"});clearTimeout(l),o({speakerName:(p==null?void 0:p.activeSpeaker)??null})}else clearTimeout(l),o({speakerName:null})}catch(u){clearTimeout(l);const p=u instanceof Error?u.message:String(u);!p.includes("Receiving end does not exist")&&!p.includes("Could not establish connection")&&console.warn("Failed to query active speaker from content script:",u),o({speakerName:null})}}};if(e.type==="QUERY_ACTIVE_SPEAKER")return c(),!0;if(e.type==="GET_STATUS")return h().then(s=>{const t=s.isRecording?"RECORDING":"PROGRAMMED";try{r({status:t,recordingStartedAt:s.recordingStartedAt??null})}catch{}}).catch(()=>{try{r({status:"PROGRAMMED",recordingStartedAt:null})}catch{}}),!0;if(e.type==="GET_SESSION"){const s=t=>{try{r({session:t})}catch{}chrome.runtime.sendMessage({type:"SESSION_RESULT",session:t}).catch(()=>{})};return _.getSession().then(s).catch(()=>s(null)),!0}return e.type==="TOGGLE_SUGGESTIONS_PANEL"?(_.getSession().then(s=>{if(!s)return;const t=["*://meet.google.com/*","https://*.zoom.us/*","https://app.zoom.us/*"];chrome.tabs.query({active:!0,currentWindow:!0},([o])=>{const l=(o==null?void 0:o.url)??"",u=l.includes("meet.google.com")||l.includes("zoom.us");if(o!=null&&o.id&&u){chrome.tabs.sendMessage(o.id,{type:"TOGGLE_SIDEBAR_TRUSTED"}).catch(()=>{});return}chrome.tabs.query({url:t},p=>{if(p.length===0)return;const S=p.find(E=>E.id===(o==null?void 0:o.id))??p[0];S!=null&&S.id&&chrome.tabs.sendMessage(S.id,{type:"TOGGLE_SIDEBAR_TRUSTED"}).catch(()=>{})})})}).catch(()=>{}),!1):(c(),!1)});async function ge(){console.log("‚úÖ [Event]: OFFSCREEN_READY signal received.")}async function he(e){var r,c,s;if(A){console.warn("‚ö†Ô∏è startCapture ignored: already processing");return}e&&(console.log(`üìå Using explicit tab ID from sender: ${e}`),await N({currentTabId:e}));const n=await h();if(n.isRecording){console.log("‚ö†Ô∏è startCapture ignored: already recording");return}if(!n.currentTabId){console.error("‚ùå No currentTabId available. Icon must be clicked first."),C("ERROR");return}A=!0;try{const t=await chrome.tabs.get(n.currentTabId);console.log("üöÄ Initiating capture flow for:",t.url),await N({isRecording:!0,recordingStartedAt:Date.now()}),C("RECORDING"),U=!1,M=[];const o=await _.getSession();if(console.log("üîë Token Debug:",{sessionPresent:!!o,accessTokenPresent:!!(o!=null&&o.access_token),accessTokenLength:(r=o==null?void 0:o.access_token)==null?void 0:r.length,accessTokenPrefix:((c=o==null?void 0:o.access_token)==null?void 0:c.substring(0,30))+"...",expiresAt:o!=null&&o.expires_at?new Date(o.expires_at*1e3).toISOString():"N/A"}),!(o!=null&&o.access_token)){console.error("‚ùå No access token available! User may need to log in."),C("ERROR"),await N({isRecording:!1}),A=!1;return}console.log("üîå Connecting WebSocket..."),console.log("üîå Connecting WebSocket..."),await K();const l="offscreen/index.html",u=chrome.runtime.getURL(l);if((await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"],documentUrls:[u]})).length===0){const E=new Promise((d,a)=>{const T=setTimeout(()=>{chrome.runtime.onMessage.removeListener(i),a(new Error("Timeout waiting for OFFSCREEN_READY"))},1e4),i=I=>{I.type==="OFFSCREEN_READY"&&(console.log("‚úÖ OFFSCREEN_READY received (Promise resolved)"),chrome.runtime.onMessage.removeListener(i),clearTimeout(T),d())};chrome.runtime.onMessage.addListener(i)});console.log("Creating offscreen document...",u);try{await chrome.offscreen.createDocument({url:u,reasons:["USER_MEDIA","AUDIO_PLAYBACK"],justification:"Recording tab audio for real-time transcription"})}catch(d){if(d.message.includes("Only a single offscreen"))console.log("‚úÖ Offscreen document already exists (caught error)");else throw d}console.log("‚è≥ Waiting for OFFSCREEN_READY..."),await E}else console.log("‚úÖ Offscreen document already exists");$=l,console.log("üé• Requesting MediaStreamId for tab:",n.currentTabId);const S=await new Promise((E,d)=>{chrome.tabCapture.getMediaStreamId({targetTabId:n.currentTabId},a=>{chrome.runtime.lastError?d(chrome.runtime.lastError):a?E(a):d(new Error("Got empty streamId"))})});if(console.log("‚úÖ Fresh StreamID generated:",S),console.log("üì§ Sending INIT_RECORDING to offscreen..."),await chrome.runtime.sendMessage({type:"INIT_RECORDING",streamId:S}),console.log("üì§ Sending initial mic state to offscreen:",j?"MUTED":"ACTIVE"),await chrome.runtime.sendMessage({type:"MIC_MUTE_STATE",muted:j}),o!=null&&o.access_token){const E=await chrome.tabs.get(n.currentTabId).catch(()=>t),d=(E==null?void 0:E.url)??(t==null?void 0:t.url)??"",a=d.match(/meet\.google\.com\/([a-z0-9-]+)/),T=a?a[1]:null;!T&&(d!=null&&d.includes("meet.google.com")||(s=t==null?void 0:t.url)!=null&&s.includes("meet.google.com"))&&console.warn("‚ö†Ô∏è externalId is null but tab has Meet URL ‚Äî re-record may create new call. url=",d==null?void 0:d.slice(0,80)),w={platform:me(d),scriptId:"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",leadName:L,externalId:T},console.log("üì§ Sending call:start (externalId for re-record):",w),y("call:start",w);const i=10,I=5e3;let f=0;g&&clearInterval(g),g=setInterval(()=>{if(U){g&&(clearInterval(g),g=null);return}if(h().then(k=>{if(!k.isRecording){g&&(clearInterval(g),g=null);return}}),f++,f>=i){console.error("‚ùå Call start failed after",i,"attempts (backend timeout)"),g&&(clearInterval(g),g=null),C("ERROR");return}console.log(`üîÑ Retrying call:start (attempt ${f}/${i})...`),w&&y("call:start",w)},I)}}catch(t){console.error("‚ùå startCapture failed:",t),t.message&&t.message.includes("Extension has not been invoked")?C("PERMISSION_REQUIRED"):C("ERROR"),await N({isRecording:!1}),$&&await ee()}finally{A=!1}}async function ee(e){if(A){console.warn("‚ö†Ô∏è stopCapture ignored: already processing");return}if(!(await h()).isRecording){console.log("‚ö†Ô∏è stopCapture ignored: not currently recording");return}A=!0,console.log("‚èπÔ∏è Stopping capture...",e?`result: ${e}`:"");try{chrome.runtime.sendMessage({type:"STOP_RECORDING"}).catch(()=>{console.log("Offscreen not reachable (already closed?)")}),$&&(await chrome.offscreen.closeDocument(),$=null),await N({isRecording:!1,recordingStartedAt:null});const r=G;G=null,C("PROGRAMMED"),y("call:end",{callId:r??void 0,result:e??void 0})}catch(r){console.error("‚ùå stopCapture failed:",r)}finally{A=!1}}async function C(e){const n=await h();console.log("Broadcasting status:",e),n.currentTabId&&chrome.tabs.sendMessage(n.currentTabId,{type:"STATUS_UPDATE",status:e}).catch(()=>{}),chrome.runtime.sendMessage({type:"STATUS_UPDATE",status:e}).catch(()=>{})}function me(e){return e?e.includes("meet.google.com")?"GOOGLE_MEET":e.includes("zoom.us")?"ZOOM_WEB":"OTHER":"OTHER"}
