var X=Object.defineProperty;var Q=(e,r,o)=>r in e?X(e,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[r]=o;var b=(e,r,o)=>Q(e,typeof r!="symbol"?r+"":r,o);import{a as P}from"./auth-kta0Vm9R.js";const Z="https://helpseller-backend-97701668075.europe-west1.run.app",ee="https://helpseller.vercel.app",j=Z.trim()||"http://localhost:3001",te=ee.trim()||"http://localhost:3000",Y=j.replace(/\/$/,""),oe=j.replace(/^http:\/\//,"ws://").replace(/^https:\/\//,"wss://").replace(/\/$/,""),re=te.replace(/\/$/,""),q=`${oe}/ws/call`;let f=null,L=[],k=null,R=0;const v=10;let G=null,H=null,x=null;function ne(e){G=e}function ae(e){H=e}function se(e){x=e}async function B(){var e,r;f&&(f.onclose=null,f.close(),f=null);try{console.log("üîÑ Getting fresh token for WS connection...");const o=await P.getFreshToken(),i=`${q}?token=${o}`;console.log("üîå Connecting WS:",q),f=new WebSocket(i),f.onopen=()=>{for(console.log("‚úÖ WS Connected"),R=0,console.log(`üöÄ Flushing ${L.length} messages from queue...`);L.length>0;){const a=L.shift();try{f.send(a),console.log("üì§ Flushed message:",JSON.parse(a).type)}catch(t){console.error("‚ùå Failed to flush message:",t)}}H&&H()},f.onmessage=a=>{try{const t=JSON.parse(a.data);console.log("üì© WS Message:",t.type),G&&G(t)}catch(t){console.error("‚ùå WS parse error:",t)}},f.onclose=a=>{if(console.error("‚ùå WS Closed",{code:a.code,reason:a.reason||"(no reason)",clean:a.wasClean}),f=null,x&&x(),R>=v){console.error("‚ùå Max reconnect attempts reached, stopping.");return}const t=a.code===1008?Math.min(5e3*Math.pow(1.5,R),3e4):2e3;R++,console.log(`Retrying WS in ${t}ms (attempt ${R}/${v})...`),k&&clearTimeout(k),k=setTimeout(()=>B(),t)},f.onerror=()=>{console.error("‚ùå WS Error (check WS Closed above for code/reason)")}}catch(o){if(console.error("‚ùå Failed to get token or connect:",o.message),(((e=o==null?void 0:o.message)==null?void 0:e.includes("No session found"))||((r=o==null?void 0:o.message)==null?void 0:r.includes("Auth session")))&&R>=2){console.error("Stopping WS reconnect: fa√ßa login no popup da extens√£o.");return}R++;const a=5e3;R<v&&(console.log(`Retrying in ${a}ms (attempt ${R}/${v})...`),k&&clearTimeout(k),k=setTimeout(()=>B(),a))}}function E(e,r){const o=JSON.stringify({type:e,payload:r});if(f&&f.readyState===WebSocket.OPEN)try{f.send(o)}catch(i){console.error(`‚ùå WS Send failed for ${e}:`,i),L.push(o)}else console.log(`‚è≥ WS queuing message: ${e} (State: ${f?f.readyState:"null"})`,r),L.push(o)}const O=class O{async detect(){const r=navigator.hardwareConcurrency||2,o=navigator.deviceMemory||4,i=navigator.connection,a=(i==null?void 0:i.effectiveType)||"unknown",t=await this.measureLatency(),n=r>=O.POWERFUL_THRESHOLD.MIN_CPU_CORES&&o>=O.POWERFUL_THRESHOLD.MIN_MEMORY_GB&&t<O.POWERFUL_THRESHOLD.MAX_LATENCY_MS,d={cpuCores:r,deviceMemory:o,connectionType:a,networkLatency:t,isPowerful:n};return console.log("üñ•Ô∏è Hardware Profile:",d),d}async measureLatency(){const o=[];for(let a=0;a<3;a++){try{const t=performance.now();await fetch(`${Y}/health`,{method:"GET",cache:"no-cache"});const n=performance.now()-t;o.push(n)}catch{console.warn(`Ping attempt ${a+1} failed, assuming high latency`),o.push(500)}a<2&&await new Promise(t=>setTimeout(t,100))}const i=o.reduce((a,t)=>a+t,0)/o.length;return Math.round(i)}async reevaluate(){return this.detect()}};b(O,"POWERFUL_THRESHOLD",{MIN_CPU_CORES:4,MIN_MEMORY_GB:4,MAX_LATENCY_MS:150});let z=O;class ce{constructor(){b(this,"worker",null);b(this,"hardwareProfile",null);b(this,"pendingRequests",new Map);b(this,"initialized",!1)}async initialize(){if(this.initialized){console.log("‚ö†Ô∏è Edge coach already initialized");return}console.log("üöÄ Initializing Edge Coach...");const r=new z;if(this.hardwareProfile=await r.detect(),console.log("üñ•Ô∏è Hardware Profile:",{cpuCores:this.hardwareProfile.cpuCores,deviceMemory:this.hardwareProfile.deviceMemory,networkLatency:`${this.hardwareProfile.networkLatency}ms`,isPowerful:this.hardwareProfile.isPowerful}),this.hardwareProfile.isPowerful&&typeof Worker<"u")try{this.worker=new Worker(new URL("/assets/objection-matcher.worker-fIiPJXmq.js",import.meta.url),{type:"module"}),this.worker.onmessage=o=>{this.handleWorkerResult(o.data)},this.worker.onerror=o=>{console.error("Worker error:",o)},console.log("Local matcher worker initialized")}catch(o){console.error("Failed to initialize worker:",o),this.hardwareProfile.isPowerful=!1}else this.hardwareProfile.isPowerful?console.log("Worker API not available (service worker context), using backend only"):console.log("Weak hardware detected, using backend only");this.initialized=!0}async processTranscript(r,o,i){var a;if(o!=="lead"&&o!=="Cliente"&&o!=="client")return null;if(!((a=this.hardwareProfile)!=null&&a.isPowerful)||!this.worker)return console.log("üì° Using backend (weak hardware or no worker)"),null;if(i.length===0)return console.warn("‚ö†Ô∏è No cached objections, falling back to backend"),null;try{const t=performance.now(),n=await this.matchLocal(r,i,200),d=performance.now()-t;return n.result?console.log(`‚ö° LOCAL MATCH: ${Math.round(d)}ms | Score: ${n.result.score.toFixed(2)} | ${n.result.coachingTip.substring(0,50)}...`):console.log(`‚ö° LOCAL: No match (${Math.round(d)}ms)`),n.result}catch(t){return t instanceof Error&&t.message==="Timeout"?console.warn("‚è±Ô∏è Local timeout (>200ms), falling back to backend"):console.error("‚ùå Local processing error:",t),null}}matchLocal(r,o,i){return new Promise((a,t)=>{const n=Math.random().toString(36).substring(2),d=setTimeout(()=>{this.pendingRequests.delete(n),t(new Error("Timeout"))},i);this.pendingRequests.set(n,{resolve:a,reject:t,timeoutId:d}),this.worker.postMessage({requestId:n,text:r,objections:o})})}handleWorkerResult(r){const o=this.pendingRequests.get(r.requestId);o&&(clearTimeout(o.timeoutId),o.resolve(r),this.pendingRequests.delete(r.requestId))}getHardwareProfile(){return this.hardwareProfile}destroy(){this.worker&&(this.worker.terminate(),this.worker=null),this.pendingRequests.clear(),this.initialized=!1,console.log("üõë Edge coach destroyed")}}const V=new ce;console.log("Background Service Worker Starting...");V.initialize().then(()=>{console.log("‚úÖ Edge coach initialized")}).catch(e=>{console.error("‚ùå Edge coach initialization failed:",e)});let N="",K=!1,w=null,W=[],D=!1,U=null,_=[],l=null;ae(()=>{l&&(clearInterval(l),l=null);const e=1500;setTimeout(()=>{w&&(console.log("üîÑ Re-sending call:start on reconnect (after",e,"ms):",w),E("call:start",w)),N&&(console.log("üë§ Re-sending lead name on reconnect:",N),E("call:participants",{leadName:N,allParticipants:[]}))},e)});se(()=>{D=!1});ne(async e=>{var r,o,i,a,t,n,d;if(e.type==="call:started"){const s=(r=e.payload)==null?void 0:r.callId;if(console.log("‚úÖ Call started confirmed by backend. CallId:",s),console.log("üé¨ Requesting LiveKit token for room:",s),D=!0,l&&(clearInterval(l),l=null),_.length>0){console.log(`Open floodgates: Sending ${_.length} buffered audio segments...`);for(const u of _)E("audio:segment",u);_=[]}if(s&&s!==U){U=s;try{const u=`${re}/api/livekit/token`;console.log("üé¨ Requesting LiveKit token for room:",s,"url:",u);const g=await P.getFreshToken(),c=await P.getSession(),m=((o=c==null?void 0:c.user)==null?void 0:o.id)??"unknown",y=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g}`},body:JSON.stringify({roomName:s,identity:`seller_${m}`,role:"publisher"})});if(y.ok){const T=await y.json(),{token:C,serverUrl:A}=T;C&&A?(console.log("‚úÖ LiveKit token received"),console.log("‚úÖ Sending START_LIVEKIT_PUBLISH to offscreen (video will appear in dashboard when published)"),chrome.runtime.sendMessage({type:"START_LIVEKIT_PUBLISH",token:C,serverUrl:A}).catch($=>console.warn("‚ö†Ô∏è Send START_LIVEKIT_PUBLISH failed:",$))):(console.warn("‚ö†Ô∏è LiveKit token missing token or serverUrl. No video in dashboard until fixed."),console.warn("   ‚Üí Set NEXT_PUBLIC_LIVEKIT_URL in the dashboard (Vercel) and redeploy."))}else{const T=await y.json().catch(()=>({}));console.warn("‚ö†Ô∏è LiveKit token failed:",T.error??y.statusText)}}catch(u){console.error("‚ùå LiveKit token/publish setup:",u)}}const{scriptId:p}=w||{};if(p)try{const u=await P.getFreshToken(),g=await fetch(`${Y}/api/scripts/${p}/objections`,{headers:{Authorization:`Bearer ${u}`}});if(g.ok){const c=await g.json();W=c,console.log(`üì¶ Cached ${c.length} objections for edge processing`)}}catch{}}if(e.type==="transcript:chunk"){const s=e.payload||{},p=s.text||"",u=s.speaker||s.role;if(console.log("üìù Received transcript:",p.substring(0,50),"speaker:",u),(u==="lead"||u==="Cliente")&&W.length>0)try{const c=await V.processTranscript(p,u,W);if(c){const m=await h();m.currentTabId&&chrome.tabs.sendMessage(m.currentTabId,{type:"COACHING_MESSAGE",data:{type:"objection",title:"OBJE√á√ÉO DETECTADA",description:c.coachingTip,metadata:c}}).catch(()=>{}),console.log("‚ö° LOCAL COACHING DELIVERED")}}catch(c){console.error("‚ùå Edge processing error:",c)}const g=await h();g.currentTabId&&chrome.tabs.sendMessage(g.currentTabId,{type:"TRANSCRIPT_RESULT",data:{text:p,isFinal:s.isFinal??!0,timestamp:Date.now(),speaker:s.speaker??(s.role==="seller"?"Voc√™":"Cliente"),role:s.role}}).catch(c=>{console.warn("Failed to send transcript to content script:",c.message)})}if(e.type==="coach:message"||e.type==="COACHING_MESSAGE"){console.log("üì° BACKEND COACHING:",(i=JSON.stringify(e.payload))==null?void 0:i.substring(0,80));const s=await h();s.currentTabId&&chrome.tabs.sendMessage(s.currentTabId,{type:"COACHING_MESSAGE",data:e.payload}).catch(()=>{})}if(e.type==="coach:whisper"){console.log("üëî MANAGER WHISPER:",(t=(a=e.payload)==null?void 0:a.content)==null?void 0:t.substring(0,50));const s=await h();s.currentTabId&&chrome.tabs.sendMessage(s.currentTabId,{type:"MANAGER_WHISPER",data:{type:"manager-whisper",source:"manager",content:e.payload.content,urgency:e.payload.urgency||"normal",timestamp:e.payload.timestamp}}).catch(()=>{})}if(e.type==="objection:detected"){console.log("‚ö° OBJECTION DETECTED:",(d=(n=e.payload)==null?void 0:n.objection)==null?void 0:d.substring(0,50));const s=await h();s.currentTabId&&chrome.tabs.sendMessage(s.currentTabId,{type:"OBJECTION_DETECTED",data:{objection:e.payload.objection,phase:e.payload.phase,tip:e.payload.tip}}).catch(()=>{})}if(e.type==="error"){console.error("‚ùå BACKEND ERROR:",e.payload);const s=await h();s.currentTabId&&chrome.tabs.sendMessage(s.currentTabId,{type:"STATUS_UPDATE",status:"ERROR",error:e.payload.message||"Erro no servidor"}).catch(()=>{})}});async function h(){const e=await chrome.storage.session.get(["streamId","currentTabId","isRecording","recordingStartedAt"]);return{streamId:e.streamId,currentTabId:e.currentTabId,isRecording:!!e.isRecording,recordingStartedAt:e.recordingStartedAt||null}}async function M(e){await chrome.storage.session.set(e)}let F=null;chrome.action.onClicked.addListener(async e=>{e.id&&(console.log("Extension icon clicked (v2 - lazy capture)..."),await M({currentTabId:e.id}),chrome.tabs.sendMessage(e.id,{type:"TOGGLE_SIDEBAR"}).catch(r=>{console.log("Content script not injected yet:",r)}))});let S=!1;chrome.runtime.onMessage.addListener((e,r,o)=>{console.log(`üì© Background received message: ${e.type}`,{senderId:r.id,senderUrl:r.url});const i=async()=>{var a;if(e.type==="START_CAPTURE")le(e.tabId||((a=r.tab)==null?void 0:a.id));else if(e.type==="STOP_CAPTURE")J();else if(e.type==="TRY_END_CALL")E("call:end",{callId:U??void 0});else if(e.type==="OFFSCREEN_READY")console.log("‚úÖ [Event]: OFFSCREEN_READY - Generating fresh StreamID..."),ie();else if(e.type==="OFFSCREEN_LOG")console.log("üñ•Ô∏è [Offscreen]:",e.message);else if(e.type==="RECORDING_STARTED"){const t=!!e.micAvailable;console.log("üéôÔ∏è Recording started, microfone:",t?"permitido":"n√£o dispon√≠vel"),h().then(n=>{n.currentTabId&&chrome.tabs.sendMessage(n.currentTabId,{type:"STATUS_UPDATE",status:"RECORDING",micAvailable:t}).catch(()=>{})}),chrome.runtime.sendMessage({type:"STATUS_UPDATE",status:"RECORDING",micAvailable:t}).catch(()=>{})}else if(e.type==="AUDIO_CHUNK")E("audio:chunk",{audio:e.data});else if(e.type==="AUDIO_SEGMENT"){const t=e.role||e.speaker||"unknown";console.log(`üì§ Sending audio segment: ${e.size} bytes, role: ${t}`);const n={audio:e.data,size:e.size,role:t,speakerName:e.speakerName};D?E("audio:segment",n):(console.log("‚è≥ Buffering audio segment (call not confirmed yet)..."),_.push(n))}else if(e.type==="MEDIA_STREAM_CHUNK")E("media:stream",{chunk:e.data,size:e.size,timestamp:e.timestamp,isHeader:!!e.isHeader});else if(e.type==="PARTICIPANT_INFO")N=e.leadName||"",console.log("üë§ Lead name:",N),E("call:participants",{leadName:e.leadName||"Lead",selfName:e.selfName,allParticipants:e.allParticipants||[]});else if(e.type==="MIC_STATE")K=e.muted,console.log("üé§ Mic state:",e.muted?"MUTED":"ACTIVE"),chrome.storage.local.set({micMuted:e.muted}).catch(()=>{}),chrome.runtime.sendMessage({type:"MIC_MUTE_STATE",muted:e.muted}).catch(()=>{});else if(e.type==="TRANSCRIPT_RESULT")E("transcript:chunk",e.data),h().then(t=>{t.currentTabId&&chrome.tabs.sendMessage(t.currentTabId,{type:"TRANSCRIPT_RESULT",data:e.data}).catch(n=>{console.error("‚ùå Failed to send transcript to sidebar:",n)})});else if(e.type==="QUERY_ACTIVE_SPEAKER"){let t=!1;const n=s=>{if(!t){t=!0;try{o(s)}catch{}}},d=setTimeout(()=>n({speakerName:null}),2e3);try{const s=await h();if(s.currentTabId){const p=await chrome.tabs.sendMessage(s.currentTabId,{type:"GET_ACTIVE_SPEAKER"});clearTimeout(d),n({speakerName:(p==null?void 0:p.activeSpeaker)??null})}else clearTimeout(d),n({speakerName:null})}catch(s){clearTimeout(d),console.warn("Failed to query active speaker from content script:",s),n({speakerName:null})}}};return e.type==="QUERY_ACTIVE_SPEAKER"?(i(),!0):e.type==="GET_STATUS"?(h().then(a=>{const t=a.isRecording?"RECORDING":"PROGRAMMED";try{o({status:t,recordingStartedAt:a.recordingStartedAt??null})}catch{}}).catch(()=>{try{o({status:"PROGRAMMED",recordingStartedAt:null})}catch{}}),!0):(i(),!1)});async function ie(){console.log("‚úÖ [Event]: OFFSCREEN_READY signal received.")}async function le(e){var o,i,a;if(S){console.warn("‚ö†Ô∏è startCapture ignored: already processing");return}e&&(console.log(`üìå Using explicit tab ID from sender: ${e}`),await M({currentTabId:e}));const r=await h();if(r.isRecording){console.log("‚ö†Ô∏è startCapture ignored: already recording");return}if(!r.currentTabId){console.error("‚ùå No currentTabId available. Icon must be clicked first."),I("ERROR");return}S=!0;try{const t=await chrome.tabs.get(r.currentTabId);console.log("üöÄ Initiating capture flow for:",t.url),await M({isRecording:!0,recordingStartedAt:Date.now()}),I("RECORDING"),D=!1,_=[];const n=await P.getSession();if(console.log("üîë Token Debug:",{sessionPresent:!!n,accessTokenPresent:!!(n!=null&&n.access_token),accessTokenLength:(o=n==null?void 0:n.access_token)==null?void 0:o.length,accessTokenPrefix:((i=n==null?void 0:n.access_token)==null?void 0:i.substring(0,30))+"...",expiresAt:n!=null&&n.expires_at?new Date(n.expires_at*1e3).toISOString():"N/A"}),!(n!=null&&n.access_token)){console.error("‚ùå No access token available! User may need to log in."),I("ERROR"),await M({isRecording:!1}),S=!1;return}console.log("üîå Connecting WebSocket..."),console.log("üîå Connecting WebSocket..."),await B();const d="offscreen/index.html",s=chrome.runtime.getURL(d);if((await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"],documentUrls:[s]})).length===0){const g=new Promise((c,m)=>{const y=setTimeout(()=>{chrome.runtime.onMessage.removeListener(T),m(new Error("Timeout waiting for OFFSCREEN_READY"))},1e4),T=C=>{C.type==="OFFSCREEN_READY"&&(console.log("‚úÖ OFFSCREEN_READY received (Promise resolved)"),chrome.runtime.onMessage.removeListener(T),clearTimeout(y),c())};chrome.runtime.onMessage.addListener(T)});console.log("Creating offscreen document...",s);try{await chrome.offscreen.createDocument({url:s,reasons:["USER_MEDIA","AUDIO_PLAYBACK"],justification:"Recording tab audio for real-time transcription"})}catch(c){if(c.message.includes("Only a single offscreen"))console.log("‚úÖ Offscreen document already exists (caught error)");else throw c}console.log("‚è≥ Waiting for OFFSCREEN_READY..."),await g}else console.log("‚úÖ Offscreen document already exists");F=d,console.log("üé• Requesting MediaStreamId for tab:",r.currentTabId);const u=await new Promise((g,c)=>{chrome.tabCapture.getMediaStreamId({targetTabId:r.currentTabId},m=>{chrome.runtime.lastError?c(chrome.runtime.lastError):m?g(m):c(new Error("Got empty streamId"))})});if(console.log("‚úÖ Fresh StreamID generated:",u),console.log("üì§ Sending INIT_RECORDING to offscreen..."),await chrome.runtime.sendMessage({type:"INIT_RECORDING",streamId:u}),console.log("üì§ Sending initial mic state to offscreen:",K?"MUTED":"ACTIVE"),await chrome.runtime.sendMessage({type:"MIC_MUTE_STATE",muted:K}),n!=null&&n.access_token){const g=await chrome.tabs.get(r.currentTabId).catch(()=>t),c=(g==null?void 0:g.url)??(t==null?void 0:t.url)??"",m=c.match(/meet\.google\.com\/([a-z0-9-]+)/),y=m?m[1]:null;!y&&(c!=null&&c.includes("meet.google.com")||(a=t==null?void 0:t.url)!=null&&a.includes("meet.google.com"))&&console.warn("‚ö†Ô∏è externalId is null but tab has Meet URL ‚Äî re-record may create new call. url=",c==null?void 0:c.slice(0,80)),w={platform:de(c),scriptId:"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",leadName:N,externalId:y},console.log("üì§ Sending call:start (externalId for re-record):",w),E("call:start",w);const T=10,C=5e3;let A=0;l&&clearInterval(l),l=setInterval(()=>{if(D){l&&(clearInterval(l),l=null);return}if(h().then($=>{if(!$.isRecording){l&&(clearInterval(l),l=null);return}}),A++,A>=T){console.error("‚ùå Call start failed after",T,"attempts (backend timeout)"),l&&(clearInterval(l),l=null),I("ERROR");return}console.log(`üîÑ Retrying call:start (attempt ${A}/${T})...`),w&&E("call:start",w)},C)}}catch(t){console.error("‚ùå startCapture failed:",t),t.message&&t.message.includes("Extension has not been invoked")?I("PERMISSION_REQUIRED"):I("ERROR"),await M({isRecording:!1}),F&&await J()}finally{S=!1}}async function J(){if(S){console.warn("‚ö†Ô∏è stopCapture ignored: already processing");return}if(!(await h()).isRecording){console.log("‚ö†Ô∏è stopCapture ignored: not currently recording");return}S=!0,console.log("‚èπÔ∏è Stopping capture...");try{chrome.runtime.sendMessage({type:"STOP_RECORDING"}).catch(()=>{console.log("Offscreen not reachable (already closed?)")}),F&&(await chrome.offscreen.closeDocument(),F=null),await M({isRecording:!1,recordingStartedAt:null});const r=U;U=null,I("PROGRAMMED"),E("call:end",{callId:r??void 0})}catch(r){console.error("‚ùå stopCapture failed:",r)}finally{S=!1}}async function I(e){const r=await h();console.log("Broadcasting status:",e),r.currentTabId&&chrome.tabs.sendMessage(r.currentTabId,{type:"STATUS_UPDATE",status:e}).catch(()=>{}),chrome.runtime.sendMessage({type:"STATUS_UPDATE",status:e}).catch(()=>{})}function de(e){return e?e.includes("meet.google.com")?"GOOGLE_MEET":e.includes("zoom.us")?"ZOOM_WEB":"OTHER":"OTHER"}
